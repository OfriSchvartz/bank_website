<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Account</title>
  <link rel="stylesheet" href="../static/styles.css">
  <link rel="stylesheet" href="../static/account.css">
</head>
<body>
  <div class="account-container" id="mainAccountContainer">
    <div class="account-header" id="accountHeader">
      <h1 id="welcomeMessage">Welcome Back, John Doe</h1>
      <p id="accountNumber">Account Number: 1234567890</p>
    </div>

    <div class="balance-section" id="balanceSection">
      <div class="balance-label" id="balanceLabel">Current Balance</div>
      <div class="balance-amount">₪<span id="balanceAmount">15,247.83</span></div>
      <div class="balance-updated" id="balanceUpdated">Last updated: 2025-06-22 14:00:00</div>
    </div>

    <div class="actions-section" id="actionsSection">
      <button class="action-btn btn-withdraw" onclick="withdrawMoney()">Withdraw Money</button>
      <button class="action-btn btn-transfer" onclick="transferMoney()">Transfer Money</button>
      <button class="action-btn btn-deposit" onclick="depositMoney()">Deposit Money</button>
    </div>

    <div class="transactions-section" id="transactionsSection">
      <h2 class="section-title">Recent Transactions</h2>
      <table class="transactions-table">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Description</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody id="transactionsTableBody">
          <!-- Opening Balance -->
          <tr class="transaction-row" id="openingBalanceRow">
            <td class="transaction-date">2025-06-10 08:00:00</td>
            <td class="transaction-description">Salary Deposit</td>
            <td class="transaction-type">Deposit</td>
            <td class="transaction-amount amount-positive">+₪15,247.83</td>
            <td class="transaction-balance">₪15,247.83</td>
          </tr>
          <!-- Static Examples -->
          <tr class="transaction-row" id="transaction1">
            <td class="transaction-date">2025-06-15 08:00:00</td>
            <td class="transaction-description">Rent Payment</td>
            <td class="transaction-type">Deposit</td>
            <td class="transaction-amount amount-positive">+₪8,500.00</td>
            <td class="transaction-balance">₪23,747.83</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Helpers
    function fmt(num) {
      return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    function fmtDateTime(date) {
      const pad = n => n.toString().padStart(2, '0');
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ` +
             `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
    }
    // Parse date text to Date object
    function parseDate(text) {
      // text in 'YYYY-MM-DD HH:mm:ss'
      const [d, t] = text.split(' ');
      return new Date(d + 'T' + t);
    }

    // Update top balance display
    function updateGlobalBalance(balance) {
      document.getElementById('balanceAmount').textContent = fmt(balance);
      document.getElementById('balanceUpdated').textContent = fmtDateTime(new Date());
    }

    // Recalculate running balances and sort rows
    function recalcBalances() {
      const tbody = document.getElementById('transactionsTableBody');
      const rows = Array.from(tbody.querySelectorAll('tr.transaction-row'));

      // Sort rows by date ascending (oldest → newest)
      const asc = rows.slice().sort((a, b) => parseDate(a.querySelector('.transaction-date').textContent) - parseDate(b.querySelector('.transaction-date').textContent));

      // Compute running balance
      let balance = 0;
      asc.forEach((row, i) => {
        const balCell = row.querySelector('.transaction-balance');
        if (row.id === 'openingBalanceRow') {
          balance = parseFloat(balCell.textContent.replace(/[^0-9.-]/g, ''));
        } else {
          const amtText = row.querySelector('.transaction-amount').textContent.replace(/[^0-9.-]/g, '');
          const amt = parseFloat(amtText) || 0;
          balance += amt;
          balCell.textContent = '₪' + fmt(balance);
        }
      });

      // Update global top
      updateGlobalBalance(balance);

      // Reorder DOM to descending (newest on top)
      const desc = asc.slice().reverse();
      tbody.innerHTML = '';
      desc.forEach(r => tbody.appendChild(r));
    }

    // Add a new transaction row
    function addRow(desc, type, amount) {
      const now = new Date();
      const tr = document.createElement('tr');
      tr.className = 'transaction-row';
      tr.innerHTML = `
        <td class="transaction-date">${fmtDateTime(now)}</td>
        <td class="transaction-description">${desc}</td>
        <td class="transaction-type">${type}</td>
        <td class="transaction-amount ${amount >= 0 ? 'amount-positive' : 'amount-negative'}">${amount >= 0 ? '+' : '-'}₪${fmt(Math.abs(amount))}</td>
        <td class="transaction-balance"></td>
      `;
      document.getElementById('transactionsTableBody').appendChild(tr);
      recalcBalances();
    }

    function withdrawMoney() {
      const current = parseFloat(document.getElementById('balanceAmount').textContent.replace(/[^0-9.-]/g, ''));
      const input = prompt('Enter amount to withdraw:');
      const amt = parseFloat(input);
      if (isNaN(amt) || amt <= 0 || amt > current) return;
      addRow('ATM Withdrawal', 'Withdrawal', -amt);
    }
    function transferMoney() {
      window.location.href = 'transfer_page.html'; // Redirect to transfer page
    }
    function depositMoney() {
      const input = prompt('Enter amount to deposit:');
      const amt = parseFloat(input);
      if (isNaN(amt) || amt <= 0) return;
      addRow('Deposit', 'Deposit', amt);
    }

    document.addEventListener('DOMContentLoaded', recalcBalances);
  </script>
</body>
</html>
